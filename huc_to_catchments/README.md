NHDHRDV2 HUC12 Creation
=======================

In Progress...


# Description
The [NHDHRDV2](http://conte-ecology.github.io/shedsGisData/) catchments are 
grouped into cataloging units, the smallest classification of hydrologic units, 
also known as hydrologic unit code (HUC) 12. These units subdivide larger 
drainages (HUC8, HUC4, HUC2) that can be reconstructed by joining all HUC12s 
by common leading digits (e.g.). For example, the HUC12s of 010802030402 and 
010802030105 are both a part of the larger HUC8 01080203, representing the 
Deerfield River.

Initial assignment of HUC12s to catchments was done using a spatial overlay 
method, assigning catchments to the HUC12 based on the largest area of overlap. 
This method produced errors as a result of discrepancies between the high 
resolution hydrography and the NHD layers as well as shoreline definition in 
the NHDHRDv2 layers. The methods outlined here are used to address these 
errors and to group catchments into HUC12 classifications with better accuracy.


# Data Sources
HUC12 layer: [Watershed Boundary Dataset](http://nhd.usgs.gov/wbd.html). 

Catchments layer: [NHDHRDV2](http://conte-ecology.github.io/shedsGisData/)


# Processing

## 1) Pre-processing Tables

### Description
The creation of two additional tables is required before processing. The first 
table identifies HUC12s that are representative solely of ocean coverage. This 
list is generated by manually assessing if a HUC12 exists for ocean area such 
as a a bay, inlet, or in some cases open ocean. The terrestrial catchments are 
not defined to be a part of these HUC12s. The HUC12s on this list are removed 
from potential assignment before the processing. The list of these HUC12s is 
saved as the `ocean_huc12s.csv` file containing one column titled "huc12". The 
current table only covers the zones overlapping the NHDHRDV2 region.

The second table identifies any manual HUC12 assignment to catchments. In some 
cases where there are big discrepancies between source datasets, the script 
does not accurately capture the correct HUC12/catchment relationship. After the 
script is run once, a visual inspection of the HUC12 assignment to catchments 
is performed. Corrections are added to the list and saved as 
`manual_huc12s.csv` with columns "featureid" and "huc12".

Both tables are currently maintained on felek in the 
`/home/kyle/hydrography_crosswalk/huc_to_catchments/tables/` directory. 


### Steps to execute
Both of the tables are uploaded to the "data" schema of the database to be 
referenced by the HUC12 assignment process. 

To upload the `ocean_huc12s.csv` table, the `upload_ocean_huc12s` script is 
called by either navigating to the directory or specifying the entire filepath. 
The script takes the filepath to the table as input. Example call:

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
`./upload_ocean_huc12s.sh sheds /home/data/tables/ocean_huc12s.csv`

The upload of the `manual_huc12s.csv` table is the same as the ocean HUC12s 
process using the `upload_manual_huc12s` script. Example call:

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
`./upload_manual_huc12s.sh sheds /home/data/tables/manual_huc12s.csv`


### Output 
The two tables are written to the database in the "data" schema as 
`ocean_huc12s` and `manual_huc12s`.


## 2) Assign HUC12s to Catchments

### Description
The script uses the spatial relationships of the catchments and their 
respective flowlines to the HUC12 layer as well as the network structure to 
assign HUC12 values to the catchment featureids. Any HUC12s outside of the 
NHDHRDV2 range along with the pre-sepcified ocean HUC12s are excluded before 
processing to improve run time and prevent false assignments. As a general 
rule, any featureid marked as a headwater stream (i.e. nothing flowing into it) 
is automatically assigned to the same HUC12 as the featureid it flows into, 
overriding all other spatial relationships. The remaining hydrography elements 
are processed by two methods:

#### Flowline-based Method
The first method of HUC12 assignment uses the `gis.truncated_flowlines` table 
in the database. This layer is intersected with the HUC12 layer (`gis.wbdhu12`) 
and the following rules are followed to define HUC12 assigment:

1. Any flowline with a single HUC12 intersection is assigned to that HUC12

2. Flowlines with multiple HUC12 intersections are assigned to the HUC12 in 
which the greatest portion of their length lies.

3. Flowlines with no HUC12 intersections are processed in the next section with 
the catchment-based method

#### Catchment-based Method
The second method of HUC12 assignment uses the `catchments` table in the 
database. All featureids not assigned in the previous section are addressed in 
this section. These instances include catchments without related 
`truncated_flowlines` (e.g. coastal catchments) as well as those that do not 
intersect any HUC12 are processed by this method. Similar rules to the previous 
method are followed:

1. Any catchment with a single HUC12 intersection is assigned to that HUC12. 

2. Catchments with multiple HUC12 intersections are assigned to the HUC12 in 
which the greatest portion of their area lies.

3. Catchments with no intersections are assigned to the HUC12 that they are 
nearest to. (Currently there are only a few cases of this scenario.)


### Steps to execute

The `assign_huc12s_to_catchments.sh` script is called by either navigating to 
the directory or specifying the entire filepath. The script takes the filepath 
to the table as input. Example call:

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`./assign_huc12s_to_catchments.sh sheds`


### Output
The `cathuc12` table is written to the "data" schema in the database.


# Contact Info

Kyle O'Neil  
koneil@usgs.gov  

